name: Test
on:
  workflow_call:
    inputs:
      image-name:
        required: true
        type: string
      image-artifact-name:
        required: true
        type: string
      artifact-test-report:
        required: true
        type: string
      report-publish-path:
        required: true
        type: string

jobs:
  build:
    name: Build mokapi
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure all tags are fetched
      - name: get version
        id: get_version
        shell: bash
        run: |
          # Fetch tags from main
          git fetch --tags --force origin main
          
          # Get the latest tag from main
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*" origin/main || echo "0.0.0")
          echo "Latest tag from main: $LATEST_TAG"
          
          # Split version into major, minor, patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "${LATEST_TAG//[!0-9.]/}"
          
          # Increment patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
      - uses: ./.github/actions/build-mokapi-image
        with:
          image-name: ${{ inputs.image-name }}
          artifact-name: ${{ inputs.image-artifact-name }}
          version: ${{ steps.get_version.outputs.version }}

  test:
    name: Run UI tests
    runs-on: ubuntu-latest
    if: "success()"
    needs: [ build ]
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - uses: ./.github/actions/run-frontend-tests
        with:
          image-name: ${{ inputs.image-name }}
          artifact-image-name: ${{ inputs.image-artifact-name }}
          artifact-test-report: ${{ inputs.artifact-test-report }}

  publish-report:
    name: Publish Playwright Report
    if: "(success() || needs.test.result == 'failure') && github.repository == 'marle3003/mokapi'"
    needs: [ test ]
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          path: src
      - uses: ./src/.github/actions/publish-test-report
        with:
          artifact-test-report: ${{ inputs.artifact-test-report }}
          test-report-path: ${{ inputs.report-publish-path }}